-- POWLAX Simple Constraint Fix\n-- Created: 2025-01-16\n-- Purpose: Simple fix for auth constraint without foreign key issues\n\nBEGIN;\n\n-- ==========================================\n-- SIMPLE APPROACH: Just remove the problematic constraint\n-- ==========================================\n\n-- The issue is that we're trying to enforce a constraint on existing data\n-- that doesn't meet the requirements. For now, let's remove the constraint\n-- and handle this properly during the authentication migration.\n\n-- Remove the problematic check constraint\nALTER TABLE users DROP CONSTRAINT IF EXISTS check_user_auth_source;\n\n-- Remove the foreign key constraint that's causing issues\nALTER TABLE users DROP CONSTRAINT IF EXISTS users_auth_user_id_fkey;\n\n-- Show current users table structure\nSELECT \n  COUNT(*) as total_users,\n  COUNT(CASE WHEN wordpress_id IS NOT NULL THEN 1 END) as wordpress_users,\n  COUNT(CASE WHEN auth_user_id IS NOT NULL THEN 1 END) as supabase_auth_users,\n  COUNT(CASE WHEN wordpress_id IS NULL AND auth_user_id IS NULL THEN 1 END) as users_without_auth\nFROM users;\n\n-- Verify tables that should exist\nSELECT \n  table_name,\n  CASE \n    WHEN table_name IN ('users', 'user_sessions', 'user_subscriptions', 'user_activity_log', 'webhook_events') \n    THEN 'âœ… CORE AUTH TABLE'\n    ELSE 'Other table'\n  END as table_type\nFROM information_schema.tables \nWHERE table_schema = 'public' \n  AND table_name IN (\n    'users', 'user_sessions', 'user_subscriptions', 'user_activity_log', \n    'webhook_events', 'registration_links', 'registration_sessions', 'user_onboarding'\n  )\nORDER BY table_name;\n\nCOMMIT;
